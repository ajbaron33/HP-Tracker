<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Monster HP Tracker</title>
<style>
  body{background:#0b0b0c;color:#e8eaed;font:16px/1.4 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:20px;}
  .card{background:#131316;border:1px solid #2a2a31;border-radius:14px;padding:12px;}
  input,button,select{padding:8px;margin:4px;border-radius:8px;border:1px solid #2a2a31;background:#1f1f24;color:#e8eaed;cursor:pointer;}
  button.image-btn.selected{background:#0066cc;color:white;}
  .row{margin:8px 0;padding:8px;border-radius:10px;}
  .row.alive{background:#0e1a12;}
  .row.down{background:#1f0f12;}
  .row.bloodied{background:#3a3100;}
  .bloodied{color:#ff6b6b;font-weight:600;}
  .conditions{margin-top:6px;font-size:0.9em;color:#d4d4d4;}
  #list{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;margin-top:12px;}
  @media (max-width: 600px){ #list{grid-template-columns:1fr;} }
  .thumb{width:50px;height:50px;object-fit:cover;border-radius:6px;cursor:pointer;}
  .thumb.dead{position:relative;}
  .thumb.dead::after{content:"‚úñ";position:absolute;top:0;left:0;width:50px;height:50px;
    background:rgba(255,0,0,0.5);color:white;font-size:32px;text-align:center;line-height:50px;border-radius:6px;}
  .edit-btn{font-size:0.8em;background:#444;margin-left:6px;}
</style>
</head>
<body>
<div class="card">
  <form id="addForm">
    <input id="name" placeholder="Monster name" required />
    <input id="hp" type="number" placeholder="Max HP" min="1" required />
    <input id="ac" type="number" placeholder="AC" />
    <input id="imgFile" type="file" accept="image/*" style="display:none" />
    <button id="imgBtn" type="button" class="image-btn">Choose Image</button>
    <button type="submit">Add</button>
    <button id="clearAll" type="button">Clear All Monsters</button>
  </form>
</div>
<div id="list"></div>
<script>
(()=>{
  const $=s=>document.querySelector(s);
  const storeKey='monster_hp_v5';
  const defaultImage="https://ajbaron33.github.io/HP-Tracker/default-monster.png"; // must exist in repo
  let monsters=load();
  let tempImage=null;

  const conditionsList=["Blinded","Charmed","Deafened","Exhaustion","Frightened","Grappled","Incapacitated","Invisible","Paralyzed","Petrified","Poisoned","Prone","Restrained","Stunned","Unconscious"];

  function save(){localStorage.setItem(storeKey,JSON.stringify(monsters));}
  function load(){try{const raw=localStorage.getItem(storeKey);return raw?JSON.parse(raw):[];}catch{return[];}}

  function addMonster(name,maxHP,ac=0,img=defaultImage){
    name=name.trim(); maxHP=Number(maxHP);
    if(!name||!maxHP) return;
    monsters.push({id:crypto.randomUUID(),name,maxHP,currentHP:maxHP,ac:Number(ac)||0,conditions:[],image:img});
    save(); render();
  }
  function damage(id,amt){const m=monsters.find(m=>m.id===id);if(!m)return;m.currentHP=Math.max(0,m.currentHP-amt);save();render();}
  function heal(id,amt){const m=monsters.find(m=>m.id===id);if(!m)return;m.currentHP=Math.min(m.maxHP,m.currentHP+amt);save();render();}
  function updateConditions(id,selected){const m=monsters.find(m=>m.id===id);if(!m)return;m.conditions=selected;save();render();}
  function deleteMonster(id){
    const m=monsters.find(m=>m.id===id); if(!m) return;
    if(confirm(`Are you sure you want to delete ${m.name}?`)){
      monsters=monsters.filter(x=>x.id!==id);
      save(); render();
    }
  }
  function editMonster(id){
    const m=monsters.find(m=>m.id===id); if(!m) return;
    const newName=prompt("Edit name:",m.name);
    const newHP=prompt("Edit Max HP:",m.maxHP);
    const newAC=prompt("Edit AC:",m.ac);
    if(newName) m.name=newName.trim();
    if(newHP) {m.maxHP=Number(newHP); if(m.currentHP>m.maxHP) m.currentHP=m.maxHP;}
    if(newAC) m.ac=Number(newAC);
    save(); render();
  }

  function rowTemplate(m){
    const bloodied=m.currentHP<=m.maxHP/2&&m.currentHP>0;
    const down=m.currentHP<=0;
    const cls=down?"row down":bloodied?"row bloodied":"row alive";
    const skull=down?"üíÄ ":"";
    const condOptions=conditionsList.map(c=>`<option value="${c}" ${m.conditions.includes(c)?'selected':''}>${c}</option>`).join('');
    const condDisplay=m.conditions.length?`<div class="conditions">Conditions: ${m.conditions.join(", ")}</div>`:"";
    return `<div class="${cls}" data-id="${m.id}">
      <div>
        <img src="${m.image||defaultImage}" class="thumb ${down?"dead":""}" onclick="window.open('${m.image||defaultImage}','_blank')" />
        <strong>${skull}${m.name}</strong> (AC ${m.ac})
        <button class="edit-btn" data-action="edit">Edit</button>
        <button class="edit-btn" data-action="delete">Delete</button>
      </div>
      ${bloodied&&!down?`<div class="bloodied">‚ö†Ô∏è Bloodied</div>`:''}
      <div>HP: ${m.currentHP}/${m.maxHP}</div>
      <input class="dmg" type="number" placeholder="Damage"/> <button class="do-dmg">Damage</button>
      <input class="heal" type="number" placeholder="Heal"/> <button class="do-heal">Heal</button>
      <div>
        <select class="condSelect" multiple size="4">${condOptions}</select>
        <button class="clear-cond" type="button">Clear Conditions</button>
      </div>
      ${condDisplay}
    </div>`;
  }

  function render(){
    const list=$('#list');
    list.innerHTML=monsters.map(rowTemplate).join('');
    list.querySelectorAll('.row').forEach(row=>{
      const id=row.dataset.id;
      const dmgInput=row.querySelector('.dmg');
      const healInput=row.querySelector('.heal');
      row.querySelector('.do-dmg').onclick=(e)=>{e.preventDefault();const v=Number(dmgInput.value||0);if(v>0)damage(id,v);};
      row.querySelector('.do-heal').onclick=(e)=>{e.preventDefault();const v=Number(healInput.value||0);if(v>0)heal(id,v);};
      dmgInput.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();const v=Number(dmgInput.value||0);if(v>0)damage(id,v);}});
      healInput.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();const v=Number(healInput.value||0);if(v>0)heal(id,v);}});
      const condSel=row.querySelector('.condSelect');
      condSel.onchange=()=>{const selected=[...condSel.options].filter(o=>o.selected).map(o=>o.value);updateConditions(id,selected);};
      row.querySelector('.clear-cond').onclick=(e)=>{e.preventDefault();updateConditions(id,[]);};
      row.querySelectorAll('.edit-btn').forEach(btn=>{
        btn.onclick=(e)=>{
          e.preventDefault();
          if(btn.dataset.action==="edit") editMonster(id);
          if(btn.dataset.action==="delete") deleteMonster(id);
        };
      });
    });
  }

  $('#addForm').addEventListener('submit',e=>{
    e.preventDefault();
    addMonster($('#name').value,$('#hp').value,$('#ac').value,tempImage||defaultImage);
    e.target.reset();
    tempImage=null;
    $('#imgBtn').textContent="Choose Image";
    $('#imgBtn').classList.remove("selected");
    $('#name').focus();
  });

  $('#clearAll').addEventListener('click',()=>{
    if(confirm('Are you sure you want to clear all monsters?')){
      monsters=[]; save(); render();
    }
  });

  $('#imgBtn').addEventListener('click',()=>$('#imgFile').click());
  $('#imgFile').addEventListener('change',e=>{
    const file=e.target.files[0];
    if(file){
      const reader=new FileReader();
      reader.onload=ev=>{
        tempImage=ev.target.result;
        $('#imgBtn').textContent="Image Selected";
        $('#imgBtn').classList.add("selected");
      };
      reader.readAsDataURL(file);
    }
  });

  render();
})();
</script>
</body>
</html>
