<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monster HP Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #222; color: #fff; }
    #monsterList { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; }
    .monster { border: 2px solid #444; padding: 10px; border-radius: 8px; position: relative; background: #333; }
    .monster.alive { background: #2e2; }
    .monster.bloodied { background: #ee2; }
    .monster.dead { background: #e22; }
    .monster h3 { margin: 0 0 5px 0; }
    .monster img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
    .skull { font-size: 1.5em; margin-left: 5px; }
    .overlayX { position: absolute; top: 5px; left: 5px; color: red; font-size: 2em; font-weight: bold; pointer-events: none; }
    .conditions { margin-top: 5px; }
    .button-row { margin-top: 5px; }
    button { margin: 2px; }
  </style>
</head>
<body>
  <h1>Monster HP Tracker</h1>
  <form id="addForm">
    <input type="text" id="name" placeholder="Monster Name" required>
    <input type="number" id="hp" placeholder="HP" required>
    <input type="number" id="ac" placeholder="AC" required>
    <input type="file" id="image" accept="image/*">
    <button type="submit">Add</button>
  </form>
  <div id="monsterList"></div>
  <button id="clearAll">Clear All</button>

  <script>
    (() => {
      const $ = (sel) => document.querySelector(sel);
      const monsterList = $('#monsterList');
      const form = $('#addForm');
      const clearAllBtn = $('#clearAll');
      let monsters = [];

      // iPad fix: ensure tapping "Add" submits the form
      const addBtn = document.querySelector('#addForm button[type="submit"]');
      addBtn.addEventListener('touchstart', (e) => {
        e.preventDefault(); form.requestSubmit();
      }, { passive: false });

      const conditionsList = [
        "Blinded","Charmed","Deafened","Exhaustion","Frightened","Grappled",
        "Incapacitated","Invisible","Paralyzed","Petrified","Poisoned",
        "Prone","Restrained","Stunned","Unconscious"
      ];

      function renderMonsters() {
        monsterList.innerHTML = '';
        monsters.forEach((m, i) => {
          const card = document.createElement('div');
          card.className = 'monster';

          let state = 'alive';
          if (m.currentHp <= 0) state = 'dead';
          else if (m.currentHp <= m.maxHp / 2) state = 'bloodied';
          card.classList.add(state);

          card.innerHTML = `
            <h3>${m.name} (AC ${m.ac}) ${state === 'dead' ? 'ðŸ’€' : ''}</h3>
            <p>HP: ${m.currentHp} / ${m.maxHp}</p>
            <img src="${m.image || 'https://raw.githubusercontent.com/ajbaron33/HP-Tracker/main/default.png'}" alt="monster" ${m.image ? 'onclick="window.open(this.src)"' : ''}>
            ${state === 'dead' ? '<div class="overlayX">X</div>' : ''}
            <div class="button-row">
              <input type="number" class="damage" placeholder="Damage">
              <input type="number" class="heal" placeholder="Healing">
              <button class="apply">Apply</button>
            </div>
            <div class="conditions">
              <select multiple class="condSelect">
                ${conditionsList.map(c => `<option value="${c}" ${m.conditions.includes(c) ? 'selected' : ''}>${c}</option>`).join('')}
              </select>
              <button class="clearCond">Clear Conditions</button>
            </div>
            <div class="button-row">
              <button class="edit">Edit</button>
              <button class="delete">Delete</button>
              <button class="duplicate">Duplicate</button>
            </div>
          `;

          card.querySelector('.apply').onclick = (e) => {
            e.preventDefault();
            const dmgVal = parseInt(card.querySelector('.damage').value) || 0;
            const healVal = parseInt(card.querySelector('.heal').value) || 0;
            m.currentHp -= dmgVal;
            m.currentHp += healVal;
            if (m.currentHp > m.maxHp) m.currentHp = m.maxHp;
            renderMonsters();
            card.querySelector('.damage').focus();
          };
          card.querySelector('.damage').addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); card.querySelector('.apply').click(); }
          });
          card.querySelector('.heal').addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); card.querySelector('.apply').click(); }
          });
          card.querySelector('.condSelect').onchange = (e) => {
            m.conditions = Array.from(e.target.selectedOptions).map(o => o.value);
          };
          card.querySelector('.clearCond').onclick = (e) => {
            e.preventDefault();
            m.conditions = [];
            renderMonsters();
          };
          card.querySelector('.edit').onclick = () => {
            const newName = prompt("Edit name:", m.name);
            if (newName !== null) m.name = newName;
            const newHp = prompt("Edit max HP:", m.maxHp);
            if (newHp !== null) { m.maxHp = parseInt(newHp); if (m.currentHp > m.maxHp) m.currentHp = m.maxHp; }
            const newAc = prompt("Edit AC:", m.ac);
            if (newAc !== null) m.ac = parseInt(newAc);
            renderMonsters();
          };
          card.querySelector('.delete').onclick = () => {
            if (confirm(`Are you sure you want to delete ${m.name}?`)) {
              monsters.splice(i, 1);
              renderMonsters();
            }
          };
          card.querySelector('.duplicate').onclick = () => {
            let baseName = m.name.replace(/\s\d+$/, '');
            let copyNum = 2;
            while (monsters.find(mon => mon.name === `${baseName} ${copyNum}`)) {
              copyNum++;
            }
            monsters.push({ ...m, name: `${baseName} ${copyNum}` });
            renderMonsters();
          };
          monsterList.appendChild(card);
        });
      }

      form.onsubmit = (e) => {
        e.preventDefault();
        const name = $('#name').value.trim();
        const hp = parseInt($('#hp').value);
        const ac = parseInt($('#ac').value);
        const fileInput = $('#image');
        let imgSrc = '';
        if (fileInput.files && fileInput.files[0]) {
          imgSrc = URL.createObjectURL(fileInput.files[0]);
        }
        monsters.push({ name, maxHp: hp, currentHp: hp, ac, image: imgSrc, conditions: [] });
        renderMonsters();
        form.reset();
        $('#name').focus();
      };

      clearAllBtn.onclick = () => {
        if (confirm("Are you sure you want to clear all monsters?")) {
          monsters = [];
          renderMonsters();
        }
      };
    })();
  </script>
</body>
</html>
