<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monster HP Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    h1 { text-align:center; }
    form { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px; }
    form input { padding:5px; }
    button { padding:5px 10px; cursor:pointer; }
    .monster { background:white; border:1px solid #ccc; padding:10px; margin:10px; border-radius:5px; display:inline-block; width:200px; vertical-align:top; position:relative; }
    .monster.bloodied { border:2px solid gold; background:#fff8dc; }
    .monster.dead { opacity:0.6; }
    .monster img { width:100%; height:120px; object-fit:cover; border-radius:4px; }
    .monster .dead-overlay { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; font-size:72px; color:red; font-weight:bold; pointer-events:none; }
    .monster h3 { margin:5px 0; text-align:center; }
    .monster p { margin:3px 0; text-align:center; }
    .controls { display:flex; justify-content:space-around; margin-top:5px; }
    .edit-btn, .delete-btn, .duplicate-btn { font-size:0.8em; margin-top:5px; }
    #imgBtn.selected { background-color:#007BFF; color:white; }
  </style>
</head>
<body>
  <h1>Monster HP Tracker</h1>
  <form id="addForm">
    <input type="text" id="name" placeholder="Name" required>
    <input type="number" id="hp" placeholder="HP" required>
    <input type="number" id="ac" placeholder="AC" required>
    <input type="number" id="dmg" placeholder="Damage">
    <input type="file" id="imgFile" accept="image/*" style="display:none">
    <button type="button" id="imgBtn">Choose Image</button>
    <button type="submit">Add</button>
  </form>
  <div id="monsters"></div>

  <script>
  (() => {
    const $ = sel => document.querySelector(sel);
    const monstersEl = $('#monsters');
    let monsters = [];
    let tempImage = null;
    let pendingFocus = null;
    let imageJustPicked = false; // for iPad Chrome

    function render() {
      monstersEl.innerHTML = '';
      monsters.forEach((m, i) => {
        const div = document.createElement('div');
        div.className = 'monster';
        if (m.hp <= m.maxHp/2 && m.hp>0) div.classList.add('bloodied');
        if (m.hp <= 0) div.classList.add('dead');
        let imgHtml = `<img src="${m.img}" alt="monster" onclick="window.open('${m.img}','_blank')">`;
        let overlay = m.hp<=0 ? `<div class="dead-overlay">X</div>` : '';
        div.innerHTML = `
          ${imgHtml}${overlay}
          <h3>${m.name}</h3>
          <p>HP: ${m.hp}/${m.maxHp}</p>
          <p>AC: ${m.ac}</p>
          <div class="controls">
            <input type="number" placeholder="Damage" class="dmgInput">
            <button class="applyDmg">Apply</button>
          </div>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
          <button class="duplicate-btn">Duplicate</button>
        `;
        monstersEl.appendChild(div);

        // Damage apply
        div.querySelector('.applyDmg').onclick = (e) => {
          e.preventDefault();
          const val = parseInt(div.querySelector('.dmgInput').value);
          if (!isNaN(val)) m.hp -= val;
          if (m.hp < 0) m.hp = 0;
          render();
          setTimeout(()=>{ div.querySelector('.dmgInput').focus(); },0);
        };

        // Edit
        div.querySelector('.edit-btn').onclick = () => {
          const newName = prompt("Edit Name:", m.name);
          if (newName!==null) m.name=newName;
          const newHp = prompt("Edit HP:", m.hp);
          if (newHp!==null) { m.hp=parseInt(newHp)||m.hp; m.maxHp=m.hp; }
          const newAc = prompt("Edit AC:", m.ac);
          if (newAc!==null) m.ac=parseInt(newAc)||m.ac;
          render();
        };

        // Delete
        div.querySelector('.delete-btn').onclick = () => {
          if (confirm(`Are you sure you want to delete ${m.name}?`)) {
            monsters.splice(i,1);
            render();
          }
        };

        // Duplicate
        div.querySelector('.duplicate-btn').onclick = () => {
          let baseName = m.name.replace(/ \d+$/,'');
          let copyCount = monsters.filter(x=>x.name.startsWith(baseName)).length+1;
          monsters.push({ ...m, name:`${baseName} ${copyCount}` });
          render();
        };
      });
    }

    $('#addForm').addEventListener('submit', e=>{
      e.preventDefault();
      const name = $('#name').value.trim();
      const hp = parseInt($('#hp').value);
      const ac = parseInt($('#ac').value);
      let img = tempImage || 'https://raw.githubusercontent.com/ajbaron33/HP-Tracker/main/default.png';
      monsters.push({ name, hp, maxHp:hp, ac, img });
      e.target.reset();
      tempImage = null;
      imageJustPicked = false;
      $('#imgBtn').textContent="Choose Image";
      $('#imgBtn').classList.remove("selected");
      render();
    });

    // iPad Chrome: force Add button to submit
    const addBtn = document.querySelector('#addForm button[type="submit"]');
    ['touchstart','touchend'].forEach(evt=>{
      addBtn.addEventListener(evt, (e)=>{
        e.preventDefault();
        document.querySelector('#addForm').requestSubmit();
      }, { passive:false });
    });

    // After picking an image
    $('#imgFile').addEventListener('change', e=>{
      const file=e.target.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=ev=>{
          tempImage=ev.target.result;
          imageJustPicked = true;
          $('#imgBtn').textContent="Image Selected";
          $('#imgBtn').classList.add("selected");
          $('#imgBtn').blur();
          $('#name').focus();
        };
        reader.readAsDataURL(file);
      } else {
        tempImage=null;
        imageJustPicked = false;
        $('#imgBtn').textContent="Choose Image";
        $('#imgBtn').classList.remove("selected");
        $('#imgBtn').blur();
        $('#name').focus();
      }
    });

    // If just picked an image, Enter should submit
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && imageJustPicked) {
        e.preventDefault();
        document.querySelector('#addForm').requestSubmit();
      }
    });

    $('#imgBtn').addEventListener('click', ()=>$('#imgFile').click());

  })();
  </script>
</body>
</html>
